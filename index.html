<!DOCTYPE html>
<html>
	<head>
		<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
		<script>
			AFRAME.registerComponent('look-at-camera', {
				init: function () {
					this.cameraEl = this.el.sceneEl.querySelector('[camera]');
				},

				tick: function () {
					if (this.cameraEl) {
						this.el.object3D.lookAt(this.cameraEl.object3D.position);
						// console.log(this.el.object3D.rotation);
					} else
					{
						this.cameraEl = this.el.sceneEl.querySelector('[camera]');
					}
				}
			})
		</script>
		<script>
			AFRAME.registerComponent('carousel-item', {
				init: function () {
					this.angle = 0;
					this.userFollow = Array.from(this.el.parentElement.children)
						.find(child => child.hasAttribute('look-at-camera'));
					
					this.myDirection = new THREE.Vector3();
					this.lac = new THREE.Vector3();
					this.height = this.el.getAttribute('geometry')?.height || 1;
				},

				tick: function () {
					this.userFollow.object3D.getWorldDirection(this.lac);
					this.el.object3D.getWorldDirection(this.myDirection);
					
					const targetScale = this.angleLikeness(this.myDirection.multiplyScalar(-1), this.lac);

					this.el.object3D.scale.set(targetScale, targetScale, targetScale);
					console.log(this.el.object3D.scale);
				},

				angleLikeness: function (a, b) {
					return (1 + a.dot(b)) / 2;
				}
			})
		</script>

		<script>
			AFRAME.registerComponent('carousel', {
				schema: {
					radius: { type: 'number', default: 1 }
				},

				init: function () {
					this.items = Array.from(this.el.children).filter(child => child.hasAttribute('carousel-item'));
					this.centralAngle = 360 / this.items.length;

					this.layoutItems();
				},

				layoutItems: function () {
					for (let i = 0; i < this.items.length; i++)
					{
						const itemAngleDegrees = i * this.centralAngle;
						const itemAngleRadians = THREE.MathUtils.degToRad(itemAngleDegrees);

						const x = this.data.radius * Math.sin(itemAngleRadians);
						const z = this.data.radius * Math.cos(itemAngleRadians);
						const y = 0.2;
						this.items[i].object3D.position.set(x, y, z);
						const boxCenter = this.items[i].getAttribute('geometry').height / 2;
						this.items[i].object3D.lookAt(new THREE.Vector3(0.0, boxCenter, 0.0));
					}
				}
			})
		</script>
	</head>
	<body>
		<a-scene
			reflection="directionalLight: a-light[type=directional]"
			xr-mode-ui="XRMode: xr"
			>
			<a-assets>
				<img id="github" src="images/test.png">
			</a-assets>

			<a-camera>
				<a-cursor color="#FAFAFA"></a-cursor>
			</a-camera>

			<!-- <a-box 
				color="red" 
				position="0 1 -2"
				scale="0.5 0.5 0.5"
				animation__hover="startEvents: mouseenter; property: scale; to: 1 1 1; dur: 300"
				animation__hoverexit="startEvents: mouseleave; property: scale; to: .5 .5 .5; dur: 300"
				animation__floating="
					property: object3D.position.y; 
					to: 1.2; 
					dir: alternate; 
					dur: 2000; 
					loop:true"
				look-at-camera
				>
			</a-box> -->

			<a-cylinder carousel scale=".2 .2 .2" radius="2" height=".1">
				<a-entity look-at-camera></a-entity>
				<a-box color='#0D0D0D' carousel-item>
					<a-image
						src="#github"
						position="0 0 4"
						rotation="270 0 0"
						scale="5 5 5"
						material="shader: flat"
						></a-image>
				</a-box>
				<a-box color='#FF0000' carousel-item></a-box>
				<a-box color='#00FF00' carousel-item></a-box>
				<a-box color='#0000FF' carousel-item></a-box>
			</a-cylinder>
		</a-scene>
	</body>
</html>
